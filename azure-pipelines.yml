trigger:
- STG

pool:
  name: DEV-AZURE
  demands: zgtsrtickappd01

stages:
  - stage: Preparation
    displayName: 'Build & Validation'
    jobs:
      - job: RegressivoRecebiveis
        displayName: 'Regressivo - Recebiveis'
        steps:
          - task: NodeTool@0
            displayName: "Install Node.js"
            inputs:
              versionSpec: "18.x"
          - script: |
              echo "Limpando arquivos anteriores"
              rm -rf "$(Build.SourcesDirectory)/cypress/screenshots"
              rm -rf "$(Build.SourcesDirectory)/results"
              rm -rf $(Build.SourcesDirectory)/cypress/results
              rm -rf '$(Build.ArtifactStagingDirectory)/cypress/screenshots'
              rm -rf "$(Build.SourcesDirectory)/allure-results"
              rm -rf "$(Build.SourcesDirectory)/allure-report"
              rm -rf "$(Build.SourcesDirectory)/node_modules"
              rm -rf /root/.cache/Cypress || true
            displayName: 'Limpar arquivos anteriores'
            condition: always()

          - script: |
              npm install
              # Instala o Allure CLI globalmente para gerar o report na pipeline
              npm install -g allure-commandline
            displayName: 'npm install + Allure CLI'

          - script: |
              # Dependências necessárias para rodar o Cypress em ambiente Linux (RHEL/CentOS)
              sudo yum install -y \
              xorg-x11-server-Xvfb \
              gtk3 \
              libnotify \
              nss \
              alsa-lib \
              libXtst \
              libXrandr \
              xdg-utils \
              libXScrnSaver
            displayName: 'Instalar dependências do Cypress'

          - script: |
             ping -c 4 receivable-stg-merchants.ticket.edenred.net
             curl -I receivable-stg-merchants.ticket.edenred.net
            displayName: 'Diagnóstico de Rede'

          # ✅ Passo 1: Execução dos Testes
          # Usamos npx cypress run diretamente passando variáveis individuais para evitar erro de parsing JSON
          - script: |
              npx cypress run --env GENERATE_PDF=true --env allure=true --env tags="@teste"
            displayName: 'Executar Testes Regressivos (Gera PDF e Allure)'
            continueOnError: true # Garante que o report seja gerado mesmo se testes falharem

          # --- GERAÇÃO DO ALLURE REPORT ---
          - script: |
              echo "Gerando Allure Report..."
              # O parâmetro --single-file (disponível em versões recentes do Allure) cria um HTML único
              allure generate allure-results --clean -o allure-report
            displayName: 'Gerar Allure Report'
            condition: always()

          # --- ZIP E PUBLICAÇÃO DO ALLURE ---
          - task: ArchiveFiles@2
            displayName: 'Compactar Allure Results em ZIP'
            condition: always()
            inputs:
              rootFolderOrFile: '$(Build.SourcesDirectory)/allure-results'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/allure-results-$(Build.BuildId).zip'
              replaceExistingArchive: true

          - task: PublishPipelineArtifact@1
            displayName: 'Upload do ZIP (Allure) para download'
            condition: always()
            inputs:
              targetPath: '$(Build.ArtifactStagingDirectory)/allure-results-$(Build.BuildId).zip'
              artifact: 'AllureResults_Download'
              publishLocation: 'pipeline'
          
          # ✅ Passo 2: Publicar o PDF Gerado
          # O PDF é gerado automaticamente na pasta "cypress/evidence" pelo código no cypress.config.js
          # Aqui nós pegamos essa pasta e salvamos como um artefato da pipeline para você baixar depois.
          - task: PublishPipelineArtifact@1
            displayName: 'Upload do Relatório PDF'
            condition: always() # Roda mesmo se testes falharem
            inputs:
              targetPath: '$(Build.SourcesDirectory)/cypress/evidence' # Pasta onde o PDF foi salvo
              artifact: 'Relatorio_PDF_Execucao' # Nome do botão de download que aparecerá no Azure
              publishLocation: 'pipeline'

          - script: |
              npm run merge:results
            displayName: "Merge JUnit Results"
            condition: succeededOrFailed()

          - task: PublishTestResults@2
            displayName: 'Publish the test reports'
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/cypress/results/combined.xml'
              testRunTitle: 'Cypress Regressivo'
              mergeTestResults: true # Consolida os arquivos em um único reporte no Azure
          
          # ❌ Script antigo removido (não precisa mais chamar manualmente o gerador de PDF)
          # - script: |
          #     node -e "require('./cypress/support/pdfHelper').generateFromScreenshots({ environmentName: 'STG' })"
          #   displayName: 'Gerar PDF de evidências'
          #   condition: always()

          # Publicar resultados nos Test Plans (vínculo por Test Plan/Suite/Case via REST API)
          - script: |
              npm install axios fast-xml-parser
              node ./scripts/publish-azure-testplans.js
            displayName: 'Publicar resultados no Azure Test Plans (descoberta automática via argumentos)'
            env:
              AZURE_ORG: "Edenred-TicketBenefits"
              AZURE_PROJECT: "Merchants"
              AZURE_PAT: ""
              AZURE_TEST_PLAN_ID: "286425"
              AZURE_TEST_SUITE_ID: "288354,287533"
            condition: succeededOrFailed()
